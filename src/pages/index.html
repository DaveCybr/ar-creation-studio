<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AR Video Player</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      * {
        box-sizing: border-box;
      }
      html,
      body {
        margin: 0 !important;
        padding: 0 !important;
        overflow: hidden !important;
        font-family: system-ui, -apple-system, sans-serif;
        width: 100% !important;
        height: 100% !important;
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
      }
      body {
        /* Override any dynamic styles from AR.js */
        margin-left: 0 !important;
        margin-top: 0 !important;
        margin-right: 0 !important;
        margin-bottom: 0 !important;
      }
      #arjs-video {
        /* Fix AR.js video positioning */
        width: 100% !important;
        height: 100% !important;
        margin: 0 !important;
        margin-left: 0 !important;
        margin-top: 0 !important;
        object-fit: cover !important;
      }
      .animate-spin {
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }
      .animate-pulse {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      }
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }
    </style>
  </head>
  <body>
    <!-- Loading Screen -->
    <div
      id="loading-screen"
      class="fixed inset-0 bg-gray-900 flex items-center justify-center"
    >
      <div class="text-center text-white">
        <svg
          class="w-12 h-12 animate-spin mx-auto mb-4 text-blue-400"
          fill="none"
          viewBox="0 0 24 24"
        >
          <circle
            class="opacity-25"
            cx="12"
            cy="12"
            r="10"
            stroke="currentColor"
            stroke-width="4"
          ></circle>
          <path
            class="opacity-75"
            fill="currentColor"
            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
          ></path>
        </svg>
        <p class="text-lg">Loading AR Experience...</p>
      </div>
    </div>

    <!-- Error Screen -->
    <div
      id="error-screen"
      class="fixed inset-0 bg-gray-900 flex items-center justify-center p-4"
      style="display: none"
    >
      <div class="max-w-md text-center text-white">
        <svg
          class="w-16 h-16 mx-auto mb-4 text-red-500"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
          />
        </svg>
        <h2 class="text-2xl font-bold mb-2">Error</h2>
        <p id="error-message" class="mb-6 text-gray-300"></p>
        <button
          onclick="location.reload()"
          class="px-6 py-3 bg-blue-500 hover:bg-blue-600 rounded-lg font-medium transition"
        >
          Reload Page
        </button>
      </div>
    </div>

    <!-- Permission Screen -->
    <div
      id="permission-screen"
      class="fixed inset-0 bg-gradient-to-br from-purple-600 to-blue-600 flex items-center justify-center p-3 sm:p-4 overflow-y-auto"
      style="display: none"
    >
      <div class="max-w-md w-full text-center text-white py-4 sm:py-0">
        <div class="mb-4 sm:mb-8">
          <div
            class="w-16 h-16 sm:w-24 sm:h-24 mx-auto mb-3 sm:mb-4 bg-white rounded-xl sm:rounded-2xl p-3 sm:p-4 shadow-2xl"
          >
            <svg viewBox="0 0 100 100" fill="none">
              <rect
                x="10"
                y="10"
                width="80"
                height="80"
                fill="#667eea"
                rx="5"
              />
              <rect x="20" y="20" width="20" height="20" fill="white" />
              <rect x="60" y="20" width="20" height="20" fill="white" />
              <rect x="20" y="60" width="20" height="20" fill="white" />
              <rect x="60" y="60" width="20" height="20" fill="white" />
            </svg>
          </div>
        </div>

        <h1 class="text-2xl sm:text-4xl font-bold mb-2 sm:mb-4">
          üé• AR Video Player
        </h1>
        <p class="text-sm sm:text-lg mb-4 sm:mb-8 opacity-90 px-2">
          Arahkan kamera ke marker HIRO untuk memutar video dalam Augmented
          Reality
        </p>

        <div
          class="bg-white/10 backdrop-blur-sm rounded-xl p-3 sm:p-4 mb-4 sm:mb-8 text-left mx-1 sm:mx-0"
        >
          <h3
            class="font-semibold mb-2 sm:mb-3 flex items-center gap-2 text-sm sm:text-base"
          >
            <svg
              class="w-4 h-4 flex-shrink-0"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
              />
            </svg>
            Tips untuk AR
          </h3>
          <ul class="space-y-1.5 sm:space-y-2 text-xs sm:text-sm opacity-90">
            <li>‚úÖ Download marker HIRO dari link di bawah</li>
            <li>‚úÖ Tampilkan marker di layar atau print</li>
            <li>‚úÖ Pencahayaan harus terang & merata</li>
            <li>‚úÖ Jarak ideal 30-50 cm dari kamera</li>
          </ul>
        </div>

        <button
          id="start-ar-btn"
          class="w-full py-3 sm:py-4 bg-white text-purple-600 rounded-xl font-bold text-base sm:text-lg transition hover:bg-gray-100 shadow-xl mb-3 sm:mb-4"
        >
          <svg
            class="w-4 h-4 sm:w-5 sm:h-5 inline mr-2"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"
            />
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"
            />
          </svg>
          Mulai AR Experience
        </button>

        <a
          href="https://raw.githubusercontent.com/AR-js-org/AR.js/master/data/images/hiro.png"
          target="_blank"
          rel="noopener noreferrer"
          class="text-xs sm:text-sm underline opacity-90 hover:opacity-100"
        >
          Download Marker HIRO ‚Üí
        </a>
      </div>
    </div>

    <!-- AR Screen -->
    <div id="ar-screen" class="fixed inset-0 bg-black" style="display: none">
      <div
        id="ar-container"
        class="absolute inset-0 w-full h-full"
        style="z-index: 1"
      ></div>

      <!-- Scanning Overlay -->
      <div
        id="scanning-overlay"
        style="
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          display: flex;
          align-items: center;
          justify-content: center;
          pointer-events: none;
          z-index: 9999;
        "
      >
        <div
          class="text-center text-white px-4"
          style="text-shadow: 0 0 10px rgba(0, 0, 0, 0.8)"
        >
          <div class="relative w-48 h-48 sm:w-64 sm:h-64 mx-auto mb-4 sm:mb-6">
            <div
              class="absolute inset-0 border-2 border-dashed border-blue-500/50 rounded-2xl animate-pulse"
            ></div>
            <div
              class="absolute -top-2 -left-2 w-6 h-6 sm:w-8 sm:h-8 border-t-2 border-l-2 border-blue-500"
            ></div>
            <div
              class="absolute -top-2 -right-2 w-6 h-6 sm:w-8 sm:h-8 border-t-2 border-r-2 border-blue-500"
            ></div>
            <div
              class="absolute -bottom-2 -left-2 w-6 h-6 sm:w-8 sm:h-8 border-b-2 border-l-2 border-blue-500"
            ></div>
            <div
              class="absolute -bottom-2 -right-2 w-6 h-6 sm:w-8 sm:h-8 border-b-2 border-r-2 border-blue-500"
            ></div>
          </div>
          <div
            class="flex items-center gap-2 justify-center text-sm sm:text-base"
          >
            <svg
              class="w-4 h-4 sm:w-5 sm:h-5 animate-spin text-blue-400"
              fill="none"
              viewBox="0 0 24 24"
            >
              <circle
                class="opacity-25"
                cx="12"
                cy="12"
                r="10"
                stroke="currentColor"
                stroke-width="4"
              ></circle>
              <path
                class="opacity-75"
                fill="currentColor"
                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
              ></path>
            </svg>
            <span class="font-medium">Scanning for HIRO marker...</span>
          </div>
        </div>
      </div>

      <!-- Top Bar -->
      <div
        class="absolute inset-x-0 top-0 p-3 sm:p-6 bg-gradient-to-b from-black/80 to-transparent z-20"
      >
        <div class="flex items-center justify-between text-white">
          <div class="flex items-center gap-2">
            <div
              class="w-7 h-7 sm:w-8 sm:h-8 rounded-lg bg-gradient-to-br from-blue-500 to-cyan-500 flex items-center justify-center"
            >
              <span class="text-white text-[10px] sm:text-xs font-bold"
                >AR</span
              >
            </div>
            <span class="font-bold text-sm sm:text-base">AR Video Player</span>
          </div>

          <div
            id="playing-badge"
            class="flex items-center gap-1.5 sm:gap-2 px-2 sm:px-3 py-1 sm:py-1.5 rounded-full bg-green-500/20 border border-green-500/30 backdrop-blur-sm"
            style="display: none"
          >
            <svg
              class="w-3 h-3 sm:w-4 sm:h-4 text-green-400"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M5 13l4 4L19 7"
              />
            </svg>
            <span class="text-xs sm:text-sm font-medium">Playing</span>
          </div>
        </div>
      </div>

      <!-- Bottom Bar -->
      <div
        class="absolute inset-x-0 bottom-0 p-3 sm:p-6 bg-gradient-to-t from-black/80 to-transparent z-20"
      >
        <div class="max-w-4xl mx-auto">
          <div class="flex items-center justify-between">
            <button
              id="back-btn"
              class="w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-black/50 backdrop-blur-sm text-white hover:bg-black/70 transition flex items-center justify-center"
            >
              <svg
                class="w-5 h-5 sm:w-6 sm:h-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
            </button>

            <div class="flex items-center gap-2 sm:gap-3">
              <button
                id="mute-btn"
                class="w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-black/50 backdrop-blur-sm text-white hover:bg-black/70 transition flex items-center justify-center"
                style="display: none"
              >
                <svg
                  id="mute-icon"
                  class="w-5 h-5 sm:w-6 sm:h-6"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"
                    clip-rule="evenodd"
                  />
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2"
                  />
                </svg>
              </button>

              <button
                id="info-btn"
                class="w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-black/50 backdrop-blur-sm text-white hover:bg-black/70 transition flex items-center justify-center"
              >
                <svg
                  class="w-5 h-5 sm:w-6 sm:h-6"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                  />
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Info Panel -->
      <div
        id="info-panel"
        class="absolute right-0 top-0 bottom-0 w-full sm:w-80 bg-black/90 backdrop-blur-md sm:border-l border-white/10 p-4 sm:p-6 overflow-y-auto z-30"
        style="display: none"
      >
        <div class="flex items-start justify-between mb-4 sm:mb-6">
          <h3 class="text-lg sm:text-xl font-bold text-white">
            AR Video Player
          </h3>
          <button
            id="close-info-btn"
            class="text-white hover:bg-white/10 p-1.5 rounded transition"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>

        <div class="space-y-3 sm:space-y-4 text-sm text-white">
          <div>
            <p class="text-white/50 mb-1 text-xs sm:text-sm">Status</p>
            <p id="info-status" class="text-sm">üîç Searching for marker...</p>
          </div>
          <div>
            <p class="text-white/50 mb-1 text-xs sm:text-sm">Video</p>
            <p class="text-sm">Big Buck Bunny (Demo)</p>
          </div>
          <div>
            <p class="text-white/50 mb-1 text-xs sm:text-sm">Audio</p>
            <p id="info-audio" class="text-sm">üîá Muted</p>
          </div>
        </div>

        <div
          class="mt-6 sm:mt-8 p-3 sm:p-4 bg-blue-500/10 border border-blue-500/30 rounded-lg"
        >
          <p class="text-xs text-blue-300">
            üí° Video akan otomatis play saat marker HIRO terdeteksi
          </p>
        </div>
      </div>
    </div>

    <script>
      let state = "loading";
      let isTracking = false;
      let isMuted = true;
      let streamRef = null;
      let videoRef = null;

      // DOM Elements
      const loadingScreen = document.getElementById("loading-screen");
      const errorScreen = document.getElementById("error-screen");
      const permissionScreen = document.getElementById("permission-screen");
      const arScreen = document.getElementById("ar-screen");
      const arContainer = document.getElementById("ar-container");
      const scanningOverlay = document.getElementById("scanning-overlay");
      const playingBadge = document.getElementById("playing-badge");
      const muteBtn = document.getElementById("mute-btn");
      const muteIcon = document.getElementById("mute-icon");
      const infoPanel = document.getElementById("info-panel");

      // Load Scripts
      async function loadScripts() {
        try {
          if (!document.getElementById("aframe-script")) {
            await new Promise((resolve, reject) => {
              const script = document.createElement("script");
              script.id = "aframe-script";
              script.src = "https://aframe.io/releases/1.3.0/aframe.min.js";
              script.onload = resolve;
              script.onerror = () =>
                reject(new Error("Failed to load A-Frame"));
              document.head.appendChild(script);
            });
            console.log("‚úÖ A-Frame loaded");
            await new Promise((resolve) => setTimeout(resolve, 500));
          }

          if (!document.getElementById("arjs-script")) {
            await new Promise((resolve, reject) => {
              const script = document.createElement("script");
              script.id = "arjs-script";
              script.src =
                "https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/aframe/build/aframe-ar.js";
              script.onload = resolve;
              script.onerror = () => reject(new Error("Failed to load AR.js"));
              document.head.appendChild(script);
            });
            console.log("‚úÖ AR.js loaded");
            await new Promise((resolve) => setTimeout(resolve, 1000));
          }

          setState("permission");
        } catch (err) {
          console.error("Failed to load:", err);
          showError(err.message);
        }
      }

      function setState(newState) {
        state = newState;
        loadingScreen.style.display = state === "loading" ? "flex" : "none";
        errorScreen.style.display = state === "error" ? "flex" : "none";
        permissionScreen.style.display =
          state === "permission" ? "flex" : "none";
        arScreen.style.display = state === "scanning" ? "block" : "none";
      }

      function showError(message) {
        document.getElementById("error-message").textContent = message;
        setState("error");
      }

      async function startAR() {
        try {
          setState("loading");

          const stream = await navigator.mediaDevices.getUserMedia({
            video: {
              facingMode: { ideal: "environment" },
              width: { ideal: 1280 },
              height: { ideal: 720 },
            },
          });

          console.log("‚úÖ Camera permission granted");
          streamRef = stream;

          setState("scanning");

          setTimeout(() => {
            setupARScene(stream);
          }, 300);
        } catch (err) {
          console.error("Camera error:", err);
          showError("Camera access denied. Please allow camera permissions.");
        }
      }

      function setupARScene(stream) {
        arContainer.innerHTML = "";

        // Device detection
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        const isAndroid = /Android/i.test(navigator.userAgent);
        const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
        
        console.log(`üì± Device: ${isAndroid ? 'Android' : (isIOS ? 'iOS' : 'Desktop')}`);

        if (stream) {
          const videoFallback = document.createElement("video");
          videoFallback.id = "camera-fallback";
          videoFallback.autoplay = true;
          videoFallback.playsInline = true;
          videoFallback.muted = true;
          videoFallback.srcObject = stream;
          videoFallback.style.cssText =
            "position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 0;";
          arContainer.appendChild(videoFallback);
          videoFallback
            .play()
            .catch((e) => console.warn("Fallback video play error:", e));
          console.log("‚úÖ Camera fallback video added");
        }

        // Debug info panel for mobile
        if (isMobile) {
          const debugPanel = document.createElement("div");
          debugPanel.id = "debug-panel";
          debugPanel.style.cssText = "position: fixed; bottom: 80px; left: 10px; background: rgba(0,0,0,0.8); color: #0f0; padding: 10px; font-family: monospace; font-size: 11px; z-index: 9999; border-radius: 8px; max-width: 200px;";
          debugPanel.innerHTML = `
            <div>Device: ${isAndroid ? 'Android' : 'iOS'}</div>
            <div>Scale: 1 -1 1 (all)</div>
            <div id="debug-video">Video: loading...</div>
            <div id="debug-marker">Marker: scanning...</div>
          `;
          document.body.appendChild(debugPanel);
        }

        const arContainerDiv = document.createElement("div");
        arContainerDiv.id = "ar-container-div";
        arContainerDiv.style.cssText =
          "position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1;";

        // Universal fix: flip Y scale untuk semua device
        const videoScale = "1 -1 1";
        const videoRotation = "-90 0 0";

        arContainerDiv.innerHTML = `
        <a-scene
          embedded
          arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
          vr-mode-ui="enabled: false"
          renderer="logarithmicDepthBuffer: true; precision: medium; antialias: true; alpha: true;"
          style="width: 100%; height: 100%; position: absolute; top: 0; left: 0;"
        >
          <a-assets>
            <video
              id="ar-video"
              src="https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4"
              preload="auto"
              loop
              muted
              playsinline
              webkit-playsinline
              crossorigin="anonymous"
            ></video>
          </a-assets>

          <a-marker
            preset="hiro"
            emitevents="true"
            smooth="true"
            smoothCount="10"
            smoothTolerance="0.01"
            smoothThreshold="5"
          >
            <a-entity
              id="video-plane"
              geometry="primitive: plane; width: 2.4; height: 1.35;"
              position="0 0 0"
              rotation="${videoRotation}"
              scale="${videoScale}"
              material="shader: flat; src: #ar-video; side: double; transparent: false; npot: true;"
            ></a-entity>
          </a-marker>

          <a-entity camera></a-entity>
        </a-scene>
      `;

        arContainer.appendChild(arContainerDiv);

        setTimeout(() => {
          const marker = document.querySelector("a-marker");
          const video = document.querySelector("#ar-video");
          const videoPlane = document.querySelector("#video-plane");

          if (video) {
            // Update video dimensions after metadata loads
            video.addEventListener('loadedmetadata', () => {
              const w = video.videoWidth;
              const h = video.videoHeight;
              console.log(`üìπ Video: ${w}x${h}`);
              
              const debugVideo = document.getElementById('debug-video');
              if (debugVideo) debugVideo.textContent = `Video: ${w}x${h}`;
              
              // Update plane aspect ratio
              if (videoPlane && w && h) {
                const aspectRatio = w / h;
                const planeWidth = 1.6;
                const planeHeight = planeWidth / aspectRatio;
                videoPlane.setAttribute('geometry', `primitive: plane; width: ${planeWidth}; height: ${planeHeight};`);
                console.log(`üìê Plane: ${planeWidth}x${planeHeight.toFixed(2)}`);
              }
            });
          }

          if (marker && video) {
            videoRef = video;

            marker.addEventListener("markerFound", () => {
              console.log("üéØ Marker found!");
              const debugMarker = document.getElementById('debug-marker');
              if (debugMarker) debugMarker.textContent = 'Marker: FOUND ‚úì';
              
              setTracking(true);
              if (video.paused) {
                video.play().catch((e) => console.warn("Play error:", e));
              }
            });

            marker.addEventListener("markerLost", () => {
              console.log("üëª Marker lost!");
              const debugMarker = document.getElementById('debug-marker');
              if (debugMarker) debugMarker.textContent = 'Marker: lost';
              
              setTimeout(() => {
                setTracking(false);
                if (!video.paused) {
                  video.pause();
                }
              }, 2000);
            });

            console.log("‚úÖ AR scene ready");
          }

          setTimeout(() => {
            const arjsVideo = document.querySelector(
              "video[autoplay][playsinline]:not(#camera-fallback):not(#ar-video)"
            );
            if (arjsVideo) {
              arjsVideo.style.cssText =
                "position: absolute !important; top: 0 !important; left: 0 !important; width: 100% !important; height: 100% !important; object-fit: cover !important; z-index: 0 !important; display: block !important;";
              console.log("‚úÖ AR.js webcam video styled");
            }

            const canvas = document.querySelector("canvas.a-canvas");
            if (canvas) {
              canvas.style.cssText =
                "position: absolute !important; z-index: 1 !important; background: transparent !important;";
              console.log("‚úÖ Canvas styled");
            }
          }, 1000);
        }, 1500);
      }

      function setTracking(tracking) {
        isTracking = tracking;
        scanningOverlay.style.display = tracking ? "none" : "flex";
        playingBadge.style.display = tracking ? "flex" : "none";
        muteBtn.style.display = tracking ? "flex" : "none";

        document.getElementById("info-status").textContent = tracking
          ? "‚úÖ Video Playing"
          : "üîç Searching for marker...";
      }

      function toggleMute() {
        if (videoRef) {
          videoRef.muted = !videoRef.muted;
          isMuted = videoRef.muted;

          if (isMuted) {
            muteIcon.innerHTML =
              '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" clip-rule="evenodd"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2"/>';
          } else {
            muteIcon.innerHTML =
              '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"/>';
          }

          document.getElementById("info-audio").textContent = isMuted
            ? "üîá Muted"
            : "üîä Unmuted";
        }
      }

      function handleBack() {
        if (streamRef) {
          streamRef.getTracks().forEach((track) => track.stop());
          streamRef = null;
        }

        const videos = document.querySelectorAll("video");
        videos.forEach((vid) => {
          if (vid.srcObject) {
            const stream = vid.srcObject;
            stream.getTracks().forEach((track) => track.stop());
          }
        });

        arContainer.innerHTML = "";
        setState("permission");
        setTracking(false);
      }

      // Event Listeners
      document
        .getElementById("start-ar-btn")
        .addEventListener("click", startAR);
      document.getElementById("back-btn").addEventListener("click", handleBack);
      document.getElementById("mute-btn").addEventListener("click", toggleMute);
      document.getElementById("info-btn").addEventListener("click", () => {
        infoPanel.style.display =
          infoPanel.style.display === "none" ? "block" : "none";
      });
      document
        .getElementById("close-info-btn")
        .addEventListener("click", () => {
          infoPanel.style.display = "none";
        });

      // Initialize
      loadScripts();
    </script>
  </body>
</html>
