<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
    />
    <meta name="mobile-web-app-capable" content="yes" />
    <title>AR Video Experience - Custom Marker</title>

    <!-- A-Frame -->
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <!-- MindAR -->
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        margin: 0;
        overflow: hidden;
        width: 100vw;
        height: 100vh;
        position: fixed;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
        background: #000;
      }

      /* Start Modal */
      #start-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        transition: opacity 0.5s ease;
        overflow-y: auto;
      }

      #start-modal.hidden {
        opacity: 0;
        pointer-events: none;
      }

      .modal-content {
        text-align: center;
        color: white;
        padding: 40px 20px;
        max-width: 450px;
        width: 90%;
      }

      .modal-icon {
        font-size: 80px;
        margin-bottom: 20px;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
      }

      .modal-title {
        font-size: 32px;
        font-weight: 700;
        margin-bottom: 10px;
        letter-spacing: -0.5px;
      }

      .modal-subtitle {
        font-size: 16px;
        margin-bottom: 30px;
        opacity: 0.9;
        line-height: 1.5;
      }

      /* Upload Section */
      .upload-section {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 25px;
        margin-bottom: 25px;
        border: 2px dashed rgba(255, 255, 255, 0.3);
      }

      .upload-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 15px;
      }

      .upload-options {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
      }

      .upload-btn {
        flex: 1;
        background: white;
        color: #667eea;
        border: none;
        padding: 15px 20px;
        font-size: 14px;
        font-weight: 600;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }

      .upload-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
      }

      .upload-btn:active {
        transform: translateY(0);
      }

      .upload-btn.secondary {
        background: rgba(255, 255, 255, 0.2);
        color: white;
      }

      #file-input,
      #mind-file-input {
        display: none;
      }

      .preview-container {
        margin-top: 15px;
        display: none;
      }

      .preview-container.visible {
        display: block;
      }

      .preview-image {
        max-width: 100%;
        max-height: 200px;
        border-radius: 12px;
        margin-bottom: 10px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
      }

      .preview-info {
        font-size: 13px;
        opacity: 0.9;
        margin-bottom: 8px;
      }

      .info-box {
        background: rgba(255, 255, 255, 0.15);
        padding: 12px;
        border-radius: 10px;
        font-size: 12px;
        line-height: 1.5;
        margin-top: 10px;
      }

      .info-box a {
        color: #ffd700;
        text-decoration: none;
        font-weight: 600;
      }

      #start-btn {
        background: white;
        color: #667eea;
        border: none;
        padding: 18px 50px;
        font-size: 18px;
        font-weight: 600;
        border-radius: 50px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      #start-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
      }

      #start-btn:active {
        transform: translateY(0);
      }

      #start-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .permission-note {
        margin-top: 20px;
        font-size: 13px;
        opacity: 0.7;
        max-width: 300px;
      }

      /* Loading Overlay */
      #loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.95);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        transition: opacity 0.5s ease;
      }

      #loading-overlay.hidden {
        opacity: 0;
        pointer-events: none;
      }

      .loading-spinner {
        width: 60px;
        height: 60px;
        border: 4px solid rgba(255, 255, 255, 0.1);
        border-top: 4px solid white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .loading-text {
        color: white;
        font-size: 16px;
        font-weight: 500;
        margin-bottom: 10px;
      }

      .loading-progress {
        color: rgba(255, 255, 255, 0.6);
        font-size: 14px;
      }

      /* Top UI Bar */
      #top-ui {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        padding: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 999;
        background: linear-gradient(
          180deg,
          rgba(0, 0, 0, 0.6) 0%,
          transparent 100%
        );
        opacity: 0;
        transition: opacity 0.5s ease;
      }

      #top-ui.visible {
        opacity: 1;
      }

      .ui-button {
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
        border: none;
        color: white;
        width: 44px;
        height: 44px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 20px;
      }

      .ui-button:active {
        transform: scale(0.95);
        background: rgba(255, 255, 255, 0.3);
      }

      /* Bottom Status */
      #bottom-status {
        position: fixed;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        padding: 12px 24px;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(10px);
        border-radius: 25px;
        color: white;
        font-size: 14px;
        font-weight: 500;
        z-index: 999;
        display: flex;
        align-items: center;
        gap: 8px;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      #bottom-status.visible {
        opacity: 1;
      }

      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #ff4444;
        animation: blink 1s infinite;
      }

      .status-dot.active {
        background: #00ff88;
        animation: none;
      }

      @keyframes blink {
        0%,
        50%,
        100% {
          opacity: 1;
        }
        25%,
        75% {
          opacity: 0.3;
        }
      }

      /* Menu Modal */
      #menu-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        backdrop-filter: blur(10px);
        z-index: 10001;
        display: none;
        align-items: center;
        justify-content: center;
      }

      #menu-modal.visible {
        display: flex;
      }

      .menu-content {
        background: white;
        border-radius: 20px;
        padding: 30px;
        max-width: 90%;
        width: 350px;
        max-height: 80vh;
        overflow-y: auto;
      }

      .menu-title {
        font-size: 24px;
        font-weight: 700;
        margin-bottom: 20px;
        color: #333;
      }

      .menu-item {
        padding: 15px;
        margin: 10px 0;
        background: #f5f5f5;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        color: #333;
        font-weight: 500;
      }

      .menu-item:active {
        transform: scale(0.98);
        background: #e0e0e0;
      }

      .menu-close {
        margin-top: 20px;
        padding: 15px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 12px;
        width: 100%;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
      }

      @media (max-width: 768px) {
        .modal-title {
          font-size: 28px;
        }

        .modal-icon {
          font-size: 60px;
        }

        .upload-options {
          flex-direction: column;
        }
      }
    </style>
  </head>
  <body>
    <!-- Start Modal -->
    <div id="start-modal">
      <div class="modal-content">
        <div class="modal-icon">üì∑</div>
        <h1 class="modal-title">AR Video Experience</h1>
        <p class="modal-subtitle">
          Upload compiled .mind file or use default marker
        </p>

        <!-- Upload Section -->
        <div class="upload-section">
          <div class="upload-title">üì§ Choose Marker</div>
          <div class="upload-options">
            <button
              class="upload-btn"
              onclick="document.getElementById('mind-file-input').click()"
            >
              Upload .mind
            </button>
            <button class="upload-btn secondary" id="use-default-btn">
              Use Default
            </button>
          </div>
          <input type="file" id="mind-file-input" accept=".mind" />
          <input
            type="file"
            id="file-input"
            accept="image/*"
            style="display: none"
          />

          <div class="preview-container" id="preview-container">
            <div class="preview-info">‚úÖ Marker file ready</div>
          </div>

          <div class="info-box">
            üìù <strong>How to create .mind file:</strong><br />
            1. Visit
            <a
              href="https://hiukim.github.io/mind-ar-js-doc/tools/compile"
              target="_blank"
              >MindAR Compiler</a
            ><br />
            2. Upload your image (PNG/JPG with details)<br />
            3. Download the .mind file<br />
            4. Upload it here!
          </div>
        </div>

        <button id="start-btn" disabled>Start AR</button>
        <p class="permission-note">Allow camera access to begin</p>
      </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="hidden">
      <div class="loading-spinner"></div>
      <div class="loading-text" id="loading-text">
        Loading tracking system...
      </div>
      <div class="loading-progress" id="loading-progress"></div>
    </div>

    <!-- Top UI -->
    <div id="top-ui">
      <button class="ui-button" id="menu-btn">‚ò∞</button>
      <button class="ui-button" id="info-btn">‚Ñπ</button>
    </div>

    <!-- Bottom Status -->
    <div id="bottom-status">
      <span class="status-dot"></span>
      <span id="status-text">Scanning for target...</span>
    </div>

    <!-- Menu Modal -->
    <div id="menu-modal">
      <div class="menu-content">
        <h2 class="menu-title">Menu</h2>
        <div class="menu-item" onclick="window.location.reload()">
          üîÑ Restart & Change Marker
        </div>
        <div class="menu-item" id="help-item">‚ùì Help</div>
        <div class="menu-item" id="compiler-link">üîß Open MindAR Compiler</div>
        <button
          class="menu-close"
          onclick="document.getElementById('menu-modal').classList.remove('visible')"
        >
          Close
        </button>
      </div>
    </div>

    <!-- AR Scene -->
    <a-scene
      id="ar-scene"
      mindar-image="imageTargetSrc: https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/card.mind; 
                  filterMinCF: 0.0001; 
                  filterBeta: 10;
                  warmupTolerance: 5;
                  missTolerance: 5;
                  autoStart: false;"
      color-space="sRGB"
      renderer="colorManagement: true, physicallyCorrectLights: false, antialias: true, alpha: true"
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: false"
      embedded
    >
      <a-assets>
        <video
          id="vid"
          src="https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ForBiggerJoyrides.mp4"
          preload="auto"
          autoplay="false"
          loop="true"
          crossorigin="anonymous"
          playsinline
          webkit-playsinline
          muted
        ></video>
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <a-entity mindar-image-target="targetIndex: 0">
        <a-video
          src="#vid"
          position="0 0 0.1"
          height="1"
          width="0.5625"
          rotation="0 0 0"
        ></a-video>

        <a-entity position="0 0 0.05">
          <a-box
            position="-0.29 0.52 0"
            scale="0.05 0.05 0.01"
            material="color: #00ff88; emissive: #00ff88; emissiveIntensity: 0.5"
          ></a-box>
          <a-box
            position="0.29 0.52 0"
            scale="0.05 0.05 0.01"
            material="color: #00ff88; emissive: #00ff88; emissiveIntensity: 0.5"
          ></a-box>
          <a-box
            position="-0.29 -0.52 0"
            scale="0.05 0.05 0.01"
            material="color: #00ff88; emissive: #00ff88; emissiveIntensity: 0.5"
          ></a-box>
          <a-box
            position="0.29 -0.52 0"
            scale="0.05 0.05 0.01"
            material="color: #00ff88; emissive: #00ff88; emissiveIntensity: 0.5"
          ></a-box>
        </a-entity>
      </a-entity>
    </a-scene>

    <script>
      const startModal = document.getElementById("start-modal");
      const loadingOverlay = document.getElementById("loading-overlay");
      const loadingText = document.getElementById("loading-text");
      const loadingProgress = document.getElementById("loading-progress");
      const topUI = document.getElementById("top-ui");
      const bottomStatus = document.getElementById("bottom-status");
      const statusText = document.getElementById("status-text");
      const statusDot = document.querySelector(".status-dot");
      const startBtn = document.getElementById("start-btn");
      const mindFileInput = document.getElementById("mind-file-input");
      const previewContainer = document.getElementById("preview-container");
      const useDefaultBtn = document.getElementById("use-default-btn");
      const menuBtn = document.getElementById("menu-btn");
      const infoBtn = document.getElementById("info-btn");
      const menuModal = document.getElementById("menu-modal");
      const helpItem = document.getElementById("help-item");
      const compilerLink = document.getElementById("compiler-link");
      const arScene = document.getElementById("ar-scene");

      let customMarkerData = null;
      let useDefault = false;

      // Use default marker
      useDefaultBtn.addEventListener("click", () => {
        useDefault = true;
        previewContainer.classList.add("visible");
        startBtn.disabled = false;
        console.log("‚úÖ Using default marker");
      });

      // Upload .mind file
      mindFileInput.addEventListener("change", async (e) => {
        const file = e.target.files[0];
        if (file) {
          loadingText.textContent = "Loading marker file...";
          loadingOverlay.classList.remove("hidden");

          try {
            const arrayBuffer = await file.arrayBuffer();
            customMarkerData = arrayBuffer;

            previewContainer.classList.add("visible");
            startBtn.disabled = false;
            loadingOverlay.classList.add("hidden");

            console.log("‚úÖ Custom .mind file loaded");
          } catch (error) {
            console.error("Error loading file:", error);
            alert("Failed to load .mind file. Please try again.");
            loadingOverlay.classList.add("hidden");
          }
        }
      });

      // Start AR
      startBtn.addEventListener("click", async () => {
        startModal.classList.add("hidden");
        loadingOverlay.classList.remove("hidden");
        loadingText.textContent = "Initializing AR...";
        loadingProgress.textContent = "Please wait...";

        try {
          const sceneEl = document.querySelector("a-scene");

          if (!useDefault && customMarkerData) {
            // Convert ArrayBuffer to base64
            const base64 = arrayBufferToBase64(customMarkerData);
            const dataUrl = `data:application/octet-stream;base64,${base64}`;

            // Update scene with custom marker
            sceneEl.setAttribute(
              "mindar-image",
              `imageTargetSrc: ${dataUrl}; filterMinCF: 0.0001; filterBeta: 10; warmupTolerance: 5; missTolerance: 5;`
            );
            console.log("‚úÖ Custom marker set");

            // Force scene to reload with new marker
            await new Promise((resolve) => setTimeout(resolve, 500));
          }

          setupARScene();
        } catch (error) {
          console.error("Error:", error);
          loadingText.textContent = "Error initializing AR";
          loadingProgress.textContent = error.message;
          setTimeout(() => {
            alert("Failed to initialize AR. Please try again.");
            window.location.reload();
          }, 2000);
        }
      });

      // Convert ArrayBuffer to base64
      function arrayBufferToBase64(buffer) {
        let binary = "";
        const bytes = new Uint8Array(buffer);
        const len = bytes.byteLength;
        for (let i = 0; i < len; i++) {
          binary += String.fromCharCode(bytes[i]);
        }
        return btoa(binary);
      }

      // Setup AR Scene
      function setupARScene() {
        const sceneEl = document.querySelector("a-scene");

        // Start MindAR
        sceneEl.addEventListener("renderstart", () => {
          console.log("üé¨ AR rendering started");
          const mindarSystem = sceneEl.systems["mindar-image-system"];
          if (mindarSystem) {
            mindarSystem.start();
            console.log("‚úÖ MindAR system started");
          }
        });

        // Check if scene is already loaded
        if (sceneEl.hasLoaded) {
          console.log("‚úÖ AR Scene already loaded");
          onSceneReady();
        } else {
          sceneEl.addEventListener("loaded", () => {
            console.log("‚úÖ AR Scene loaded");
            onSceneReady();
          });
        }
      }

      function onSceneReady() {
        setTimeout(() => {
          loadingOverlay.classList.add("hidden");
          topUI.classList.add("visible");
          bottomStatus.classList.add("visible");

          setupAREvents();
        }, 1500);
      }

      // Setup AR events
      function setupAREvents() {
        const video = document.getElementById("vid");
        const targetEl = document.querySelector("[mindar-image-target]");

        if (!targetEl) {
          console.error("Target element not found");
          return;
        }

        targetEl.addEventListener("targetFound", () => {
          console.log("‚úÖ Target found!");
          statusText.textContent = "Target detected ‚Ä¢ Playing";
          statusDot.classList.add("active");

          if (video && video.paused) {
            video.play().catch((err) => {
              video.muted = true;
              video.play();
            });
          }
        });

        targetEl.addEventListener("targetLost", () => {
          console.log("‚ùå Target lost");
          statusText.textContent = "Scanning for target...";
          statusDot.classList.remove("active");

          if (video && !video.paused) {
            video.pause();
          }
        });
      }

      // UI Buttons
      menuBtn.addEventListener("click", () => {
        menuModal.classList.add("visible");
      });

      infoBtn.addEventListener("click", () => {
        alert(
          "Point your camera at your marker image to see the AR video. Make sure you have good lighting and hold your device steady."
        );
      });

      helpItem.addEventListener("click", () => {
        alert(
          "How to use:\n\n1. Create .mind file at MindAR Compiler\n2. Upload the .mind file here\n3. Print or display the original image\n4. Point camera at the image\n\nOR use the default marker!"
        );
      });

      compilerLink.addEventListener("click", () => {
        window.open(
          "https://hiukim.github.io/mind-ar-js-doc/tools/compile",
          "_blank"
        );
      });

      console.log("üöÄ AR Video Experience initialized");
    </script>
  </body>
</html>
