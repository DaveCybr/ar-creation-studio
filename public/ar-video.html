<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
    />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <title>AR Video Experience - Custom Marker</title>

    <!-- A-Frame -->
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <!-- MindAR -->
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <!-- MindAR Compiler -->
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image.prod.js"></script>

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        margin: 0;
        overflow: hidden;
        width: 100vw;
        height: 100vh;
        position: fixed;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
        background: #000;
      }

      /* Start Modal */
      #start-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        transition: opacity 0.5s ease;
        overflow-y: auto;
      }

      #start-modal.hidden {
        opacity: 0;
        pointer-events: none;
      }

      .modal-content {
        text-align: center;
        color: white;
        padding: 40px 20px;
        max-width: 450px;
        width: 90%;
      }

      .modal-icon {
        font-size: 80px;
        margin-bottom: 20px;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
      }

      .modal-title {
        font-size: 32px;
        font-weight: 700;
        margin-bottom: 10px;
        letter-spacing: -0.5px;
      }

      .modal-subtitle {
        font-size: 16px;
        margin-bottom: 30px;
        opacity: 0.9;
        line-height: 1.5;
      }

      /* Upload Section */
      .upload-section {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 25px;
        margin-bottom: 25px;
        border: 2px dashed rgba(255, 255, 255, 0.3);
      }

      .upload-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 15px;
      }

      .upload-options {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
      }

      .upload-btn {
        flex: 1;
        background: white;
        color: #667eea;
        border: none;
        padding: 15px 20px;
        font-size: 14px;
        font-weight: 600;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }

      .upload-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
      }

      .upload-btn:active {
        transform: translateY(0);
      }

      .upload-btn.secondary {
        background: rgba(255, 255, 255, 0.2);
        color: white;
      }

      #file-input {
        display: none;
      }

      .preview-container {
        margin-top: 15px;
        display: none;
      }

      .preview-container.visible {
        display: block;
      }

      .preview-image {
        max-width: 100%;
        max-height: 200px;
        border-radius: 12px;
        margin-bottom: 10px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
      }

      .preview-info {
        font-size: 13px;
        opacity: 0.9;
      }

      #start-btn {
        background: white;
        color: #667eea;
        border: none;
        padding: 18px 50px;
        font-size: 18px;
        font-weight: 600;
        border-radius: 50px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      #start-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
      }

      #start-btn:active {
        transform: translateY(0);
      }

      #start-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .permission-note {
        margin-top: 20px;
        font-size: 13px;
        opacity: 0.7;
        max-width: 300px;
      }

      /* Loading Overlay */
      #loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.95);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        transition: opacity 0.5s ease;
      }

      #loading-overlay.hidden {
        opacity: 0;
        pointer-events: none;
      }

      .loading-spinner {
        width: 60px;
        height: 60px;
        border: 4px solid rgba(255, 255, 255, 0.1);
        border-top: 4px solid white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .loading-text {
        color: white;
        font-size: 16px;
        font-weight: 500;
        margin-bottom: 10px;
      }

      .loading-progress {
        color: rgba(255, 255, 255, 0.6);
        font-size: 14px;
      }

      /* Top UI Bar */
      #top-ui {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        padding: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 999;
        background: linear-gradient(
          180deg,
          rgba(0, 0, 0, 0.6) 0%,
          transparent 100%
        );
        opacity: 0;
        transition: opacity 0.5s ease;
      }

      #top-ui.visible {
        opacity: 1;
      }

      .ui-button {
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
        border: none;
        color: white;
        width: 44px;
        height: 44px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 20px;
      }

      .ui-button:active {
        transform: scale(0.95);
        background: rgba(255, 255, 255, 0.3);
      }

      /* Bottom Status */
      #bottom-status {
        position: fixed;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        padding: 12px 24px;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(10px);
        border-radius: 25px;
        color: white;
        font-size: 14px;
        font-weight: 500;
        z-index: 999;
        display: flex;
        align-items: center;
        gap: 8px;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      #bottom-status.visible {
        opacity: 1;
      }

      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #ff4444;
        animation: blink 1s infinite;
      }

      .status-dot.active {
        background: #00ff88;
        animation: none;
      }

      @keyframes blink {
        0%,
        50%,
        100% {
          opacity: 1;
        }
        25%,
        75% {
          opacity: 0.3;
        }
      }

      /* Menu Modal */
      #menu-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        backdrop-filter: blur(10px);
        z-index: 10001;
        display: none;
        align-items: center;
        justify-content: center;
      }

      #menu-modal.visible {
        display: flex;
      }

      .menu-content {
        background: white;
        border-radius: 20px;
        padding: 30px;
        max-width: 90%;
        width: 350px;
      }

      .menu-title {
        font-size: 24px;
        font-weight: 700;
        margin-bottom: 20px;
        color: #333;
      }

      .menu-item {
        padding: 15px;
        margin: 10px 0;
        background: #f5f5f5;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        color: #333;
        font-weight: 500;
      }

      .menu-item:active {
        transform: scale(0.98);
        background: #e0e0e0;
      }

      .menu-close {
        margin-top: 20px;
        padding: 15px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 12px;
        width: 100%;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
      }

      @media (max-width: 768px) {
        .modal-title {
          font-size: 28px;
        }

        .modal-icon {
          font-size: 60px;
        }

        .upload-options {
          flex-direction: column;
        }
      }
    </style>
  </head>
  <body>
    <!-- Start Modal -->
    <div id="start-modal">
      <div class="modal-content">
        <div class="modal-icon">üì∑</div>
        <h1 class="modal-title">AR Video Experience</h1>
        <p class="modal-subtitle">
          Upload your own marker image or use the default one
        </p>

        <!-- Upload Section -->
        <div class="upload-section">
          <div class="upload-title">üì§ Choose Marker Image</div>
          <div class="upload-options">
            <button
              class="upload-btn"
              onclick="document.getElementById('file-input').click()"
            >
              Upload Image
            </button>
            <button class="upload-btn secondary" id="use-default-btn">
              Use Default
            </button>
          </div>
          <input
            type="file"
            id="file-input"
            accept="image/png,image/jpeg,image/jpg"
          />

          <div class="preview-container" id="preview-container">
            <img id="preview-image" class="preview-image" />
            <div class="preview-info">‚úÖ Marker ready to use</div>
          </div>
        </div>

        <button id="start-btn" disabled>Start AR</button>
        <p class="permission-note">Allow camera access to begin</p>
      </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="hidden">
      <div class="loading-spinner"></div>
      <div class="loading-text" id="loading-text">
        Loading tracking system...
      </div>
      <div class="loading-progress" id="loading-progress"></div>
    </div>

    <!-- Top UI -->
    <div id="top-ui">
      <button class="ui-button" id="menu-btn">‚ò∞</button>
      <button class="ui-button" id="info-btn">‚Ñπ</button>
    </div>

    <!-- Bottom Status -->
    <div id="bottom-status">
      <span class="status-dot"></span>
      <span id="status-text">Scanning for target...</span>
    </div>

    <!-- Menu Modal -->
    <div id="menu-modal">
      <div class="menu-content">
        <h2 class="menu-title">Menu</h2>
        <div class="menu-item" onclick="window.location.reload()">
          üîÑ Restart & Change Marker
        </div>
        <div class="menu-item" id="help-item">‚ùì Help</div>
        <button
          class="menu-close"
          onclick="document.getElementById('menu-modal').classList.remove('visible')"
        >
          Close
        </button>
      </div>
    </div>

    <!-- AR Scene (will be created dynamically) -->
    <div id="ar-container"></div>

    <script>
      const startModal = document.getElementById("start-modal");
      const loadingOverlay = document.getElementById("loading-overlay");
      const loadingText = document.getElementById("loading-text");
      const loadingProgress = document.getElementById("loading-progress");
      const topUI = document.getElementById("top-ui");
      const bottomStatus = document.getElementById("bottom-status");
      const statusText = document.getElementById("status-text");
      const statusDot = document.querySelector(".status-dot");
      const startBtn = document.getElementById("start-btn");
      const fileInput = document.getElementById("file-input");
      const previewContainer = document.getElementById("preview-container");
      const previewImage = document.getElementById("preview-image");
      const useDefaultBtn = document.getElementById("use-default-btn");
      const menuBtn = document.getElementById("menu-btn");
      const infoBtn = document.getElementById("info-btn");
      const menuModal = document.getElementById("menu-modal");
      const helpItem = document.getElementById("help-item");

      let markerImageFile = null;
      let compiledMarkerData = null;

      // Use default marker
      useDefaultBtn.addEventListener("click", async () => {
        loadingText.textContent = "Loading default marker...";
        loadingProgress.textContent = "";
        loadingOverlay.classList.remove("hidden");

        try {
          // Fetch default image
          const response = await fetch(
            "https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/card.png"
          );
          const blob = await response.blob();
          const file = new File([blob], "default-marker.png", {
            type: "image/png",
          });

          markerImageFile = file;
          previewImage.src = URL.createObjectURL(file);
          previewContainer.classList.add("visible");
          startBtn.disabled = false;

          loadingOverlay.classList.add("hidden");
          console.log("‚úÖ Default marker loaded");
        } catch (error) {
          console.error("Error loading default marker:", error);
          alert("Failed to load default marker. Please upload your own image.");
          loadingOverlay.classList.add("hidden");
        }
      });

      // File upload
      fileInput.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file) {
          markerImageFile = file;
          previewImage.src = URL.createObjectURL(file);
          previewContainer.classList.add("visible");
          startBtn.disabled = false;
          console.log("‚úÖ Custom marker uploaded:", file.name);
        }
      });

      // Start AR
      startBtn.addEventListener("click", async () => {
        if (!markerImageFile) {
          alert("Please select a marker image first!");
          return;
        }

        startModal.classList.add("hidden");
        loadingOverlay.classList.remove("hidden");
        loadingText.textContent = "Compiling marker image...";
        loadingProgress.textContent = "This may take 10-30 seconds";

        try {
          // Compile marker
          const imageData = await loadImage(markerImageFile);
          loadingProgress.textContent = "Processing features...";

          const compiler = new window.MINDAR.IMAGE.Compiler();
          compiledMarkerData = await compiler.compileImageTargets(
            [imageData],
            (progress) => {
              loadingProgress.textContent = `Processing: ${Math.round(
                progress * 100
              )}%`;
            }
          );

          console.log("‚úÖ Marker compiled successfully");

          // Create AR scene
          loadingText.textContent = "Initializing AR...";
          loadingProgress.textContent = "";
          await createARScene(compiledMarkerData);
        } catch (error) {
          console.error("Error:", error);
          alert(
            "Failed to compile marker. Please try another image with more features (patterns, textures, contrasts)."
          );
          window.location.reload();
        }
      });

      // Load image as ImageData
      function loadImage(file) {
        return new Promise((resolve) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement("canvas");
            canvas.width = img.width;
            canvas.height = img.height;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0);
            const imageData = ctx.getImageData(
              0,
              0,
              canvas.width,
              canvas.height
            );
            resolve(imageData);
          };
          img.src = URL.createObjectURL(file);
        });
      }

      // Create AR Scene
      async function createARScene(markerData) {
        const container = document.getElementById("ar-container");

        const sceneHTML = `
          <a-scene
            mindar-image="imageTargetSrc: #compiled-marker;
                        filterMinCF: 0.0001; 
                        filterBeta: 10;
                        warmupTolerance: 5;
                        missTolerance: 5;"
            color-space="sRGB"
            renderer="colorManagement: true, physicallyCorrectLights: false, antialias: true, alpha: true"
            vr-mode-ui="enabled: false"
            device-orientation-permission-ui="enabled: false"
            embedded
          >
            <a-assets>
              <video
                id="vid"
                src="https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ForBiggerJoyrides.mp4"
                preload="auto"
                autoplay="false"
                loop="true"
                crossorigin="anonymous"
                playsinline
                webkit-playsinline
                muted
              ></video>
            </a-assets>

            <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

            <a-entity mindar-image-target="targetIndex: 0">
              <a-video
                src="#vid"
                position="0 0 0.1"
                height="1"
                width="0.5625"
                rotation="0 0 0"
              ></a-video>

              <a-entity position="0 0 0.05">
                <a-box position="-0.29 0.52 0" scale="0.05 0.05 0.01" 
                       material="color: #00ff88; emissive: #00ff88; emissiveIntensity: 0.5"></a-box>
                <a-box position="0.29 0.52 0" scale="0.05 0.05 0.01" 
                       material="color: #00ff88; emissive: #00ff88; emissiveIntensity: 0.5"></a-box>
                <a-box position="-0.29 -0.52 0" scale="0.05 0.05 0.01" 
                       material="color: #00ff88; emissive: #00ff88; emissiveIntensity: 0.5"></a-box>
                <a-box position="0.29 -0.52 0" scale="0.05 0.05 0.01" 
                       material="color: #00ff88; emissive: #00ff88; emissiveIntensity: 0.5"></a-box>
              </a-entity>
            </a-entity>
          </a-scene>
        `;

        container.innerHTML = sceneHTML;

        // Store compiled data
        const sceneEl = document.querySelector("a-scene");
        sceneEl.setAttribute(
          "mindar-image",
          `imageTargetSrc: data:application/octet-stream;base64,${btoa(
            String.fromCharCode(...new Uint8Array(markerData.exportData()))
          )}`
        );

        // Wait for scene to load
        sceneEl.addEventListener("loaded", () => {
          console.log("‚úÖ AR Scene initialized");
          setupAREvents();

          setTimeout(() => {
            loadingOverlay.classList.add("hidden");
            topUI.classList.add("visible");
            bottomStatus.classList.add("visible");
          }, 1000);
        });
      }

      // Setup AR events
      function setupAREvents() {
        const video = document.getElementById("vid");
        const targetEl = document.querySelector("[mindar-image-target]");

        if (!targetEl) {
          console.error("Target element not found");
          return;
        }

        targetEl.addEventListener("targetFound", () => {
          console.log("‚úÖ Target found!");
          statusText.textContent = "Target detected ‚Ä¢ Playing";
          statusDot.classList.add("active");

          if (video && video.paused) {
            video.play().catch((err) => {
              video.muted = true;
              video.play();
            });
          }
        });

        targetEl.addEventListener("targetLost", () => {
          console.log("‚ùå Target lost");
          statusText.textContent = "Scanning for target...";
          statusDot.classList.remove("active");

          if (video && !video.paused) {
            video.pause();
          }
        });
      }

      // UI Buttons
      menuBtn.addEventListener("click", () => {
        menuModal.classList.add("visible");
      });

      infoBtn.addEventListener("click", () => {
        alert(
          "Point your camera at your uploaded marker image to see the AR video. Make sure you have good lighting and hold your device steady."
        );
      });

      helpItem.addEventListener("click", () => {
        alert(
          "Tips for best marker:\n\n1. Use images with lots of details and patterns\n2. Avoid plain colors or simple shapes\n3. High contrast images work better\n4. Image should be at least 480x480px\n5. Print or display on another screen"
        );
      });

      console.log("üöÄ AR Video Experience with Custom Marker initialized");
    </script>
  </body>
</html>
